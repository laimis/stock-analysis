name: App Log Monitoring

on:
    schedule:
        - cron: '*/5 * * * *'  # Run every 5 minutes

jobs:
    monitor_logs:
        runs-on: ubuntu-latest
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Retrieve app logs
              id: get_logs
              run: |
                  logs=$(doctl apps logs ${{ secrets.DIGITALOCEAN_APP_ID }})
                  echo "$logs" >> $GITHUB_OUTPUT

            - name: Check for errors
              if: contains(steps.get_logs.outputs.logs, 'error:')
              run: |
                  echo "Errors found in the app logs:"
                  echo "${{ steps.get_logs.outputs.logs }}"
                  exit 1
                  
            - name: Disable workflow
              if: steps.check_errors.outputs.has_errors == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Disabling the workflow to prevent further notifications."
                  gh workflow disable "App Log Monitoring"

            - name: Fail the workflow
              if: steps.check_errors.outputs.has_errors == 'true'
              run: exit 1
