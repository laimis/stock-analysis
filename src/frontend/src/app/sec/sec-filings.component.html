<div class="container-fluid mt-3">
  <div class="row mb-3">
    <div class="col-md-8">
      <h3>SEC Filing Center</h3>
    </div>
    <div class="col-md-4 text-end">
      @if (activeTab === 'portfolio') {
        <button class="btn btn-secondary" (click)="loadPortfolioFilings()" [disabled]="loading.portfolio">
          <i class="fas fa-sync" [ngClass]="{'fa-spin': loading.portfolio}"></i>
          Refresh
        </button>
      }
    </div>
  </div>

  @if (errors.length > 0) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      @for (error of errors; track error) {
        <div>{{ error }}</div>
      }
      <button type="button" class="btn-close" (click)="errors = []"></button>
    </div>
  }

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'search'" (click)="onTabChange('search')" href="javascript:void(0)">
        <i class="fas fa-search me-2"></i>Company Search
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'portfolio'" (click)="onTabChange('portfolio')" href="javascript:void(0)">
        <i class="fas fa-briefcase me-2"></i>My Portfolio
        @if (portfolioFilings.length > 0) {
          <span class="badge bg-info ms-1">{{ portfolioFilings.length }}</span>
        }
      </a>
    </li>
  </ul>

  <!-- Search Tab -->
  @if (activeTab === 'search') {
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-8">
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search by ticker or company name..." 
              [(ngModel)]="searchQuery"
              (keyup.enter)="searchCompanies()">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" (click)="searchCompanies()" [disabled]="loading.search || !searchQuery.trim()">
              <i class="fas fa-search me-2"></i>Search
            </button>
          </div>
        </div>

        @if (loading.search) {
          <div class="text-center mt-3">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Searching...</span>
            </div>
          </div>
        }

        @if (searchResults.length > 0 && !loading.search) {
          <div class="mt-3">
            <h5>Search Results</h5>
            <div class="list-group">
              @for (result of searchResults; track result.ticker) {
                <a 
                  href="javascript:void(0)" 
                  class="list-group-item list-group-item-action"
                  [class.active]="selectedCompany?.ticker === result.ticker"
                  (click)="selectCompany(result)">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ result.ticker }}</h6>
                    <small class="text-muted">CIK: {{ result.cik }}</small>
                  </div>
                  <p class="mb-1">{{ result.companyName }}</p>
                </a>
              }
            </div>
          </div>
        }

        @if (searchQuery && searchResults.length === 0 && !loading.search) {
          <div class="alert alert-info mt-3">
            No companies found matching "{{ searchQuery }}".
          </div>
        }
      </div>
    </div>

    @if (selectedCompany) {
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <app-stock-link-and-tradingview-link [ticker]="selectedCompany.ticker"></app-stock-link-and-tradingview-link>
            <span class="ms-2 text-muted">{{ selectedCompany.companyName }}</span>
          </h5>
          <button class="btn btn-sm btn-outline-secondary" (click)="clearSelection()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
        <div class="card-body">
          @if (loading.filings) {
            <div class="text-center py-5">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading filings...</span>
              </div>
            </div>
          }

          @if (selectedFilings && !loading.filings) {
            @if (selectedFilings.filings.length === 0) {
              <div class="alert alert-info">
                No SEC filings found for {{ selectedCompany.ticker }}.
              </div>
            } @else {
              <div class="table-responsive">
                <table class="table table-modern table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Filing Date</th>
                      <th scope="col">Report Date</th>
                      <th scope="col">Form</th>
                      <th scope="col">Description</th>
                      <th scope="col" class="text-end">Links</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (group of groupFilingsByMonth(selectedFilings.filings); track group.yearMonth) {
                      <tr>
                        <td colspan="5" class="bg-white fw-normal small border-top">
                          {{ formatYearMonth(group.yearMonth) }}
                        </td>
                      </tr>
                      @for (filing of group.filings; track filing.filingUrl) {
                        <tr>
                          <td class="text-muted">{{ formatDate(filing.filingDate) | date:'mediumDate' }}</td>
                          <td class="text-muted">{{ formatDate(filing.reportDate) | date:'mediumDate' }}</td>
                          <td>
                            <span class="badge bg-primary">{{ filing.filing }}</span>
                          </td>
                          <td class="text-muted">{{ filing.description || 'N/A' }}</td>
                          <td class="text-end text-muted">
                            <a [href]="filing.filingUrl" target="_blank" class="btn btn-sm btn-outline-primary me-2" title="View filing index" rel="noopener noreferrer">
                              <i class="bi bi-file-earmark-text"></i> Filing
                            </a>
                            <a [href]="filing.documentUrl" target="_blank" class="btn btn-sm btn-outline-secondary" title="View document" rel="noopener noreferrer">
                              <i class="bi bi-file-earmark-pdf"></i> Document
                            </a>
                          </td>
                        </tr>
                      }
                    }
                  </tbody>
                </table>
              </div>
            }
          }
        </div>
      </div>
    }
  }

  <!-- Portfolio Tab -->
  @if (activeTab === 'portfolio') {
    @if (loading.portfolio) {
      <div class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading portfolio filings...</span>
        </div>
      </div>
    }

    @if (!loading.portfolio && portfolioFilings.length === 0) {
      <div class="alert alert-info">
        No recent filings found for your portfolio holdings in the last 2 days.
      </div>
    }

    @if (!loading.portfolio && portfolioFilings.length > 0) {
      @for (tickerFiling of portfolioFilings; track tickerFiling.ticker) {
        <div class="card mb-3">
          <div class="card-header">
            <h5 class="mb-0">
              <app-stock-link-and-tradingview-link [ticker]="tickerFiling.ticker"></app-stock-link-and-tradingview-link>
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-modern table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Filing Date</th>
                    <th scope="col">Report Date</th>
                    <th scope="col">Form</th>
                    <th scope="col">Description</th>
                    <th scope="col" class="text-end">Links</th>
                  </tr>
                </thead>
                <tbody>
                  @for (filing of tickerFiling.filings; track filing.filingUrl) {
                    <tr>
                      <td class="text-muted">{{ formatDate(filing.filingDate) | date:'mediumDate' }}</td>
                      <td class="text-muted">{{ formatDate(filing.reportDate) | date:'mediumDate' }}</td>
                      <td>
                        <span class="badge bg-primary">{{ filing.filing }}</span>
                      </td>
                      <td class="text-muted">{{ filing.description || 'N/A' }}</td>
                      <td class="text-end text-muted">
                        <a [href]="filing.filingUrl" target="_blank" class="btn btn-sm btn-outline-primary me-2" title="View filing index" rel="noopener noreferrer">
                          <i class="bi bi-file-earmark-text"></i> Filing
                        </a>
                        <a [href]="filing.documentUrl" target="_blank" class="btn btn-sm btn-outline-secondary" title="View document" rel="noopener noreferrer">
                          <i class="bi bi-file-earmark-pdf"></i> Document
                        </a>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      }
    }
  }
</div>
