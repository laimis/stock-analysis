<div class="container-fluid mt-3">
  <div class="row mb-3">
    <div class="col-md-8">
      <h3>SEC Filing Center</h3>
    </div>
    <div class="col-md-4 text-end">
      @if (activeTab === 'portfolio') {
        <button class="btn btn-secondary" (click)="loadPortfolioFilings()" [disabled]="loading.portfolio">
          <i class="fas fa-sync" [ngClass]="{'fa-spin': loading.portfolio}"></i>
          Refresh
        </button>
      }
    </div>
  </div>

  @if (errors.length > 0) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      @for (error of errors; track error) {
        <div>{{ error }}</div>
      }
      <button type="button" class="btn-close" (click)="errors = []"></button>
    </div>
  }

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'search'" (click)="onTabChange('search')" href="javascript:void(0)">
        <i class="fas fa-search me-2"></i>Company Search
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'portfolio'" (click)="onTabChange('portfolio')" href="javascript:void(0)">
        <i class="fas fa-briefcase me-2"></i>My Portfolio
        @if (portfolioFilings.length > 0) {
          <span class="badge bg-info ms-1">{{ portfolioFilings.length }}</span>
        }
      </a>
    </li>
  </ul>

  <!-- Search Tab -->
  @if (activeTab === 'search') {
    <div class="card mb-3">
      <div class="card-body">
        <div class="position-relative">
          <label for="companySearch" class="form-label">Search by ticker or company name</label>
          <div class="position-relative">
            <input 
              type="text" 
              id="companySearch"
              class="form-control pe-5" 
              placeholder="Type to search..." 
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchChange($event)"
              (keydown)="onKeyDown($event)"
              (blur)="onBlur()"
              autocomplete="off">
            @if (loading.search) {
              <span class="spinner-border spinner-border-sm position-absolute end-0 top-0 bottom-0 my-auto me-2"
                    role="status"
                    aria-hidden="true"></span>
            }
          </div>

          @if (searchResults.length > 0) {
            <div class="position-absolute w-100 mt-1 bg-white border rounded shadow-sm" style="z-index: 1000; max-height: 400px; overflow-y: auto;">
              <div class="list-group list-group-flush">
                @for (result of searchResults; track result.ticker; let i = $index) {
                  <button 
                    type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-start text-start border-0"
                    [class.active]="i === highlightedIndex"
                    (click)="selectCompany(result)">
                    <div class="w-100">
                      <div class="d-flex w-100 justify-content-between align-items-center">
                        <span class="fw-bold">{{ result.ticker }}</span>
                        <small class="text-muted ms-2">CIK: {{ result.cik }}</small>
                      </div>
                      <small class="text-muted">{{ result.companyName }}</small>
                    </div>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>

    @if (selectedCompany) {
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <app-stock-link-and-tradingview-link [ticker]="selectedCompany.ticker"></app-stock-link-and-tradingview-link>
            <span class="ms-2 text-muted">{{ selectedCompany.companyName }}</span>
          </h5>
          <button class="btn btn-sm btn-outline-secondary" (click)="clearSelection()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
        <div class="card-body">
          <app-sec-filings-table 
            [filings]="selectedFilings?.filings || []"
            [loading]="loading.filings"
            [emptyMessage]="'No SEC filings found for ' + selectedCompany.ticker + '.'">
          </app-sec-filings-table>
        </div>
      </div>
    }
  }

  <!-- Portfolio Tab -->
  @if (activeTab === 'portfolio') {
    @if (loading.portfolio) {
      <div class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading portfolio filings...</span>
        </div>
      </div>
    }

    @if (!loading.portfolio && portfolioFilings.length === 0) {
      <div class="alert alert-info">
        No recent filings found for your portfolio holdings in the last 2 days.
      </div>
    }

    @if (!loading.portfolio && portfolioFilings.length > 0) {
      @for (tickerFiling of portfolioFilings; track tickerFiling.ticker) {
        <div class="card mb-3">
          <div class="card-header">
            <h5 class="mb-0">
              <app-stock-link-and-tradingview-link [ticker]="tickerFiling.ticker"></app-stock-link-and-tradingview-link>
            </h5>
          </div>
          <div class="card-body p-0">
            <app-sec-filings-table 
              [filings]="tickerFiling.filings"
              [loading]="false"
              [emptyMessage]="'No recent filings for ' + tickerFiling.ticker">
            </app-sec-filings-table>
          </div>
        </div>
      }
    }
  }
</div>
