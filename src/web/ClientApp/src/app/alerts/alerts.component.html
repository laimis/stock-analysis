<div *ngIf="alertGroups">

  <section>
    <button class="btn btn-primary me-2" (click)="scheduleRun()" *ngIf="!hideScheduling">
      Schedule Check
    </button>
    <button class="btn btn-primary me-2" (click)="toggleVisibility(messagesSection)" *ngIf="!hideMessages">
      Toggle Messages ({{container.messages.length}})
    </button>
    <div class="float-end text-muted" role="status">
      last refresh: {{lastRefreshed | date:'medium'}}
    </div>

    <div class="alert alert-success mt-3" role="alert" *ngIf="scheduled">
      Scheduled!
    </div>
  </section>

  <section #messagesSection class="visually-hidden">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Message</th>
          <th>date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let alert of container.messages">
          <td>{{alert.message}}</td>
          <td>{{alert.when | date:'medium'}}</td>
        </tr>
    </table>
  </section>

  <ng-container *ngFor="let g of alertGroups">

    <section>
      <h5>{{g[0].identifier}} ({{g.length}})</h5>
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="sort-header" (click)="sort('ticker')">Ticker</th>
            <th class="sort-header" (click)="sort('description')">Description</th>
            <th class="sort-header" (click)="sort('watchedValue')">Watched Value</th>
            <th class="sort-header" (click)="sort('triggeredValue')">Triggered Value</th>
            <th class="sort-header" (click)="sort('when')"></th>
            <th class="sort-header" (click)="sort('sourceList')">Source</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let alert of g"
            [ngClass]="{
              'table-warning': alert.alertType === 'Negative',
              'table-success': alert.alertType === 'Positive',
              'text-white': alert.alertType === 'Positive'
            }">
            <td>
              <app-stock-link-and-tradingview-link [ticker]="alert.ticker"></app-stock-link-and-tradingview-link>
            </td>
            <td>
              {{alert.description}}
            </td>
            <td>{{getValue(alert.watchedValue, alert.valueFormat)}}</td>
            <td>{{getValue(alert.triggeredValue, alert.valueFormat)}}</td>
            <td>Triggered on {{alert.when | date:'short'}}</td>
            <td>
              <a [routerLink]="[ '/stocks/lists', alert.sourceList ]">{{alert.sourceList}}</a>
            </td>
          </tr>
      </table>
    </section>
  </ng-container>

  <section *ngIf="!container.alerts">
    No alerts were triggered
  </section>

  <section *ngIf="!hideRecentTriggered">
    <h5>Recent Triggers</h5>
    <table *ngIf="container.recentlyTriggered && !hideRecentTriggered" class="table table-hover">
      <thead>
        <tr>
          <th>ticker</th>
          <th>description</th>
          <th>date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let alert of container.recentlyTriggered" [ngClass]="{'bg-warning': alert.alertType === 'Negative', 'bg-success': alert.alertType === 'Positive'}">
          <td>
            <app-stock-link-and-tradingview-link [ticker]="alert.ticker"></app-stock-link-and-tradingview-link>
          </td>
          <td>{{alert.description}}</td>
          <td>{{alert.when | date:'short'}}</td>
        </tr>
    </table>
  </section>

  <div *ngIf="!container.recentlyTriggered">
    No recent triggers
  </div>
</div>
