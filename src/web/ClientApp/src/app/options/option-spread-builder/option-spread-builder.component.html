<div>
    <app-error-display [errors]="errors"></app-error-display>
    
    <h2>Option Trade Builder - {{ ticker }} <span *ngIf="optionChain">{{optionChain.stockPrice}}</span></h2>

    <app-loading *ngIf="!optionChain"></app-loading>

    <div class="row" *ngIf="optionChain">
        <div class="col-md-8">
            <div class="mb-3">
                <label for="expirationFilter" class="mr-2">Expiration:</label>
                <select id="expirationFilter" [(ngModel)]="filterExpiration" (change)="applyFiltersAndSort()">
                    <option value="">All</option>
                    <option *ngFor="let exp of getUniqueExpirations()" [value]="exp">{{ exp }}</option>
                </select>
    
                <label for="typeFilter" class="ml-3 mr-2">Type:</label>
                <select id="typeFilter" [(ngModel)]="filterType" (change)="applyFiltersAndSort()">
                    <option value="all">All</option>
                    <option value="call">Call</option>
                    <option value="put">Put</option>
                </select>
                
                <label for="volumeOIFilter" class="ml-3 mr-2">Volume/OI:</label>
                <select id="volumeOIFilter" [(ngModel)]="filterVolumeOI" (change)="applyFiltersAndSort()">
                    <option value="all">All</option>
                    <option value="notzero">Not Zero</option>
                </select>
                
                <label for="sideFilter" class="ml-3 mr-2">Side:</label>
                <select id="sideFilter" [(ngModel)]="filterSide" (change)="applyFiltersAndSort()">
                    <option value="all">All</option>
                    <option value="put">Put</option>
                    <option value="call">Call</option>
                </select>
            </div>
    
            <table class="table table-striped table-sm">
                <thead>
                <tr>
                    <th (click)="setSort('strike')">Strike</th>
                    <th (click)="setSort('expiration')">Expiration</th>
                    <th>Type</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Spread</th>
                    <th>Last</th>
                    <th>Volume</th>
                    <th>OI</th>
                    <th>IV</th>
                    <th>Delta</th>
                    <th>Gamma</th>
                    <th>Theta</th>
                    <th>Vega</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let option of filteredOptions">
                    <td>{{ option.strikePrice | currency }}</td>
                    <td>{{ option.expirationDate }}</td>
                    <td>{{ option.side }}</td>
                    <td>{{ option.bid | currency }}</td>
                    <td>{{ option.ask | currency }}</td>
                    <td>{{ abs(option.bid - option.ask) | number}}</td>
                    <td> TODO </td>
                    <td>{{ option.volume | number }}</td>
                    <td>{{ option.openInterest | number }}</td>
                    <td>{{ option.volatility| number:'.2' }}</td>
                    <td>{{ option.delta | number:'.2' }}</td>
                    <td>{{ option.gamma | number:'.2' }}</td>
                    <td>{{ option.theta | number:'.2' }}</td>
                    <td>{{ option.vega | number:'.2' }}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-2" (click)="addBuy(option)">Buy</button>
                        <button class="btn btn-sm btn-secondary" (click)="addSell(option)">Sell</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    
        <div class="col-md-4">
            <h3>Selected Legs</h3>
            <ul class="list-group">
                <li *ngFor="let leg of selectedLegs; let i = index" class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {{leg.action}}
                            <input type="number" [(ngModel)]="leg.quantity" (change)="updateLegQuantity(i, leg.quantity)" min="1" style="width: 60px;">
                            {{ leg.option.side }} {{ leg.option.strikePrice }} {{ leg.option.expirationDate }}
                            <div>
                                {{ leg.option.bid | currency }} x {{ leg.option.ask | currency }}
                            </div>
                        </div>
                        
                        <button class="btn btn-sm btn-danger" (click)="removeLeg(i)">Remove</button>
                    </div>
                </li>
            </ul>
            <div class="mt-3">
                <h4>Trade Summary</h4>
                <p>{{ calculateLeastFavorable() | currency }} x {{ calculateMostFavorable() | currency }}  [mid: {{ calculateMidOfFavorables() | currency}} ]</p>
                
            </div>
        </div>
    </div>
    
</div>
